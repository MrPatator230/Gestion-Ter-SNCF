"use strict";(()=>{var e={};e.id=3619,e.ids=[3619],e.modules={1117:e=>{e.exports=require("mysql2/promise")},2202:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{config:()=>h,default:()=>f});var i=t(1117),a=t.n(i),o=t(7313),n=t(9021),c=t.n(n),l=t(3873),u=t.n(l),d=e([o]);o=(d.then?(await d)():d)[0];let h={api:{bodyParser:!1}},m=u().join(process.cwd(),"public","fiches-horaires");async function p(e,r){console.log("Connecting to DB with:",{host:process.env.MYSQL_HOST,user:process.env.MYSQL_USER,database:process.env.MYSQL_DATABASE});let t=await a().createConnection({host:process.env.MYSQL_HOST||"127.0.0.1",port:process.env.MYSQL_PORT?parseInt(process.env.MYSQL_PORT):8889,user:process.env.MYSQL_USER,password:process.env.MYSQL_PASSWORD,database:process.env.MYSQL_DATABASE}),[s]=await t.execute(e,r);return await t.end(),s}async function f(e,r){if("GET"===e.method)try{let e=await p("SELECT * FROM fiches_horaires ORDER BY created_at DESC");r.status(200).json(e)}catch(e){console.error("Error fetching fiches horaires:",e),r.status(500).json({error:"Erreur lors de la r\xe9cup\xe9ration des fiches horaires"})}else if("POST"===e.method){c().existsSync(m)||c().mkdirSync(m,{recursive:!0});let t=(0,o.default)({allowEmptyFiles:!1});t.uploadDir=m,t.keepExtensions=!0,t.parse(e,async(e,t,s)=>{if(e)return console.error("Error parsing form:",e),r.status(500).json({error:"Erreur lors du traitement du fichier"});let i=t.displayName,a=s.file;if(Array.isArray(a)&&(a=a[0]),console.log("Uploaded file object:",a),!i||!a)return r.status(400).json({error:"Nom d'affichage et fichier sont requis"});if(0===a.size)return r.status(400).json({error:"Le fichier t\xe9l\xe9charg\xe9 est vide"});let o=a.filepath||a.path;if(!o||"string"!=typeof o)return console.error("Uploaded file path is missing or invalid"),r.status(400).json({error:"Chemin du fichier t\xe9l\xe9charg\xe9 manquant ou invalide"});let n=a.originalFilename||a.name;n&&"string"==typeof n||(n="uploaded_file"),n=n.replace(/[^a-zA-Z0-9.-]/g,"_");let l=u().join(m,n);try{let e=l;if(c().existsSync(l)){let r=Date.now(),t=u().extname(n),s=u().basename(n,t);e=u().join(m,`${s}-${r}${t}`)}await c().promises.rename(o,e);let t=u().relative(process.cwd(),e).replace(/\\/g,"/"),s=await p("INSERT INTO fiches_horaires (display_name, file_path) VALUES (?, ?)",[i,t]);r.status(201).json({id:s.insertId,displayName:i,filePath:t})}catch(e){console.error("Error saving file or metadata:",e.stack||e),r.status(500).json({error:"Erreur lors de l'enregistrement du fichier"})}})}else r.setHeader("Allow",["GET","POST"]),r.status(405).end(`M\xe9thode ${e.method} non autoris\xe9e`)}s()}catch(e){s(e)}})},3480:(e,r,t)=>{e.exports=t(5600)},3873:e=>{e.exports=require("path")},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6435:(e,r)=>{Object.defineProperty(r,"M",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},7313:e=>{e.exports=import("formidable")},7603:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{config:()=>u,default:()=>l,routeModule:()=>d});var i=t(3480),a=t(8667),o=t(6435),n=t(2202),c=e([n]);n=(c.then?(await c)():c)[0];let l=(0,o.M)(n,"default"),u=(0,o.M)(n,"config"),d=new i.PagesAPIRouteModule({definition:{kind:a.A.PAGES_API,page:"/api/fiches-horaires",pathname:"/api/fiches-horaires",bundlePath:"",filename:""},userland:n});s()}catch(e){s(e)}})},8667:(e,r)=>{Object.defineProperty(r,"A",{enumerable:!0,get:function(){return t}});var t=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9021:e=>{e.exports=require("fs")}};var r=require("../../webpack-api-runtime.js");r.C(e);var t=r(r.s=7603);module.exports=t})();